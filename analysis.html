<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>AI ë¶„ì„</title>
  <link rel="stylesheet" href="style.css" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@latest/dist/web/variable/pretendardvariable-dynamic-subset.css" />
  <script src="env.js"></script>
  <style>
    .chart-line { position: relative; min-height: 220px; }
    .chart-line .chart-empty{ position:absolute; inset:0; display:flex; align-items:center; justify-content:center; color:rgba(0,0,0,.6); font-size:14px; text-align:center; padding:8px; }
    .chart-line .chart-svg{ width:100%; height:100%; display:block; }
  </style>
</head>
<body data-page="analytics">
  <div class="wrap">
    <header>
      <div class="top-bar">
        <div class="time">19:31</div>
        <div class="status" aria-hidden="true"><span>ğŸ“¶</span><span>ğŸ“¡</span><span>ğŸ”‹</span></div>
      </div>
      <div class="top-actions">
        <a class="btn" href="log.html">ë¡œê·¸</a>
        <div>
          <a class="icon-btn" href="alerts.html" aria-label="ì•Œë¦¼">ğŸ””</a>
          <a class="icon-btn" href="search.html" aria-label="ê²€ìƒ‰">ğŸ”</a>
          <button class="icon-btn" id="openDrawer" aria-label="ì „ì²´ ë©”ë‰´">ğŸ§­</button>
        </div>
      </div>
    </header>

    <main class="section stack">
      <!-- í™˜ê²½ ì„ íƒ -->
      <section class="insight">
        <h3>ê·¸ë¦°ë£¨í‹´ì´ ë³¸ @@ë‹˜ì€...</h3>

        <form id="envForm" class="env-form" aria-label="ìƒí™œí™˜ê²½ ì„ íƒ">
          <label class="env-field">
            <span class="label">ì£¼ê±°í˜•íƒœ</span>
            <select id="envHousing" required>
              <option value="">ì„ íƒ</option>
              <option value="ì›ë£¸">ì›ë£¸</option>
              <option value="ì˜¤í”¼ìŠ¤í…”">ì˜¤í”¼ìŠ¤í…”</option>
              <option value="ì•„íŒŒíŠ¸">ì•„íŒŒíŠ¸</option>
              <option value="ë¹Œë¼/ë‹¤ê°€êµ¬">ë¹Œë¼/ë‹¤ê°€êµ¬</option>
            </select>
          </label>

          <label class="env-field">
            <span class="label">ì´ì¤‘ë¬¸</span>
            <select id="envDoors" required>
              <option value="">ì„ íƒ</option>
              <option value="ìˆìŒ">ìˆìŒ</option>
              <option value="ì—†ìŒ">ì—†ìŒ</option>
            </select>
          </label>

          <label class="env-field">
            <span class="label">ì°½í˜¸</span>
            <select id="envWindows" required>
              <option value="">ì„ íƒ</option>
              <option value="ë‹¨ì°½">ë‹¨ì°½</option>
              <option value="ì´ì¤‘ì°½">ì´ì¤‘ì°½</option>
              <option value="ë¡œì´/ë‹¨ì—´">ë¡œì´/ë‹¨ì—´</option>
            </select>
          </label>

          <button type="submit" class="btn env-save">ì €ì¥</button>
        </form>

        <p id="envSummary" class="small" style="margin-top:6px">
          ì„ íƒí•œ í™˜ê²½ì„ ë°”íƒ•ìœ¼ë¡œ íŒê³¼ ë¶„ì„ì„ ê°œì¸í™”í•´ë“œë ¤ìš”.
        </p>
      </section>

      <!-- ë¼ì¸ì°¨íŠ¸ -->
      <section class="panel">
        <h3>@@ë‹˜ì˜ í•˜ë£¨ ì—ë„ˆì§€ ì‚¬ìš©ëŸ‰ ê·¸ë˜í”„</h3>
        <div class="chart-line">ë¼ì¸ ì°¨íŠ¸ ì˜ì—­</div>
      </section>

      <!-- ë§ì¶¤ íŒ -->
      <section class="stack" style="gap:12px">
        <article class="tip-card">
          <h4>ì „ê¸°</h4>
          <ul id="elecTips"><li>ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘â€¦</li></ul>
        </article>
        <article class="tip-card">
          <h4>ê°€ìŠ¤</h4>
          <ul id="gasTips"><li>ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘â€¦</li></ul>
        </article>
      </section>
    </main>

    <footer>
      <div class="tabs">
        <a class="tab" href="index.html" aria-label="í™ˆ">í™ˆ</a>
        <a class="tab active" href="analysis.html" aria-label="AI ë¶„ì„">AI</a>
        <a class="tab" href="goals.html" aria-label="ì‹¤ì‹œê°„ ìš”ê¸ˆ">ìš”ê¸ˆ</a>
        <a class="tab" href="profile.html" aria-label="ë§ˆì´í˜ì´ì§€">ë§ˆì´</a>
        <button class="tab" id="openDrawer2" type="button" aria-label="ì „ì²´">ì „ì²´</button>
      </div>
    </footer>
  </div>

  <div class="scrim" id="scrim"></div>
  <aside class="drawer" id="drawer" aria-label="ì „ì²´ ë©”ë‰´">
    <div class="d-hero">
      <div class="d-avatar">ğŸ‘¤</div>
      <div>
        <div class="d-name">@@ë‹˜</div>
        <div class="d-email">aaa123@gmail.com</div>
      </div>
    </div>

    <div class="d-grid">
      <a class="d-btn" href="profile.html"><div class="emoji">ğŸ‘¤</div><div class="label">ì •ë³´ ê´€ë¦¬</div></a>
      <a class="d-btn" href="alerts.html"><div class="emoji">ğŸ””</div><div class="label">ì•Œë¦¼</div></a>
      <a class="d-btn" href="#"><div class="emoji">ğŸ“¢</div><div class="label">ê³µì§€ì‚¬í•­</div></a>
      <a class="d-btn" href="profile.html"><div class="emoji">ğŸ‘¤</div><div class="label">ë§ˆì´í˜ì´ì§€</div></a>
      <a class="d-btn" href="#"><div class="emoji">ğŸ’¬</div><div class="label">ê³ ê°ì„¼í„°</div></a>
      <a class="d-btn" href="search.html"><div class="emoji">ğŸ”</div><div class="label">ê²€ìƒ‰</div></a>
    </div>

    <div class="d-hr"></div>
    <div class="d-actions">
      <a href="#">ë¡œê·¸ì•„ì›ƒ</a>
      <a href="#">íƒˆí‡´í•˜ê¸°</a>
    </div>
  </aside>

  <!-- í™˜ê²½ ì €ì¥(POST /api/ai/preference) + ì €ì¥ ì„±ê³µì‹œ íŒ GET -->
    <!-- í™˜ê²½ ì €ì¥ + ë¡œì»¬ ê°œì¸í™” (ë°±ì—”ë“œ í˜¸ì¶œ ì—†ìŒ ë²„ì „) -->
  <script>
    (function(){
      const $ = s => document.querySelector(s);
      const form = $('#envForm'); if(!form) return;
      const ho = $('#envHousing'), dr = $('#envDoors'), wi = $('#envWindows');
      const out = $('#envSummary');
      const KEY = 'envPrefs.v2';

      function renderSummary(){
        const h = ho.value || 'ì£¼ê±°í˜•íƒœ ë¯¸ì„ íƒ';
        const d = dr.value || 'ì´ì¤‘ë¬¸ ë¯¸ì„ íƒ';
        const w = wi.value || 'ì°½í˜¸ ë¯¸ì„ íƒ';
        out.textContent = `${h} / ${d} / ${w} ê¸°ì¤€ìœ¼ë¡œ íŒê³¼ ë¶„ì„ì„ ë³´ì—¬ë“œë ¤ìš”.`;
        out.style.color = '';
      }

      function loadSaved(){
        try{
          const saved = JSON.parse(localStorage.getItem(KEY) || '{}');
          if(saved.housing) ho.value = saved.housing;
          if(saved.doors)   dr.value = saved.doors;
          if(saved.windows) wi.value = saved.windows;
        }catch(e){}
        renderSummary();
        // ì €ì¥ëœ ê°’ ê¸°ì¤€ìœ¼ë¡œ ìµœì´ˆ íŒ/ê·¸ë˜í”„ ì„¸íŒ…
        if(typeof window.updateTipsFromEnv === 'function') window.updateTipsFromEnv();
        if(typeof window.updateChartFromEnv === 'function') window.updateChartFromEnv();
      }

      form.addEventListener('submit', (e)=>{
        e.preventDefault();
        if(!ho.value || !dr.value || !wi.value){
          out.textContent = 'ëª¨ë“  í•­ëª©ì„ ì„ íƒí•´ ì£¼ì„¸ìš”.';
          out.style.color = '#e11d48';
          return;
        }
        const payload = {
          housing: ho.value,
          doors: dr.value,
          windows: wi.value,
          ts: Date.now()
        };
        localStorage.setItem(KEY, JSON.stringify(payload));
        renderSummary();
        out.textContent = 'ì €ì¥ ì™„ë£Œ! ì„ íƒ ì •ë³´ì— ë§ê²Œ ì•„ë˜ ë‚´ìš©ì´ ì—…ë°ì´íŠ¸ ë˜ì—ˆì–´ìš”.';

        if(typeof window.updateTipsFromEnv === 'function') window.updateTipsFromEnv();
        if(typeof window.updateChartFromEnv === 'function') window.updateChartFromEnv();
      });

      ['change','input'].forEach(ev =>
        [ho,dr,wi].forEach(el => el.addEventListener(ev, renderSummary))
      );

      document.addEventListener('DOMContentLoaded', loadSaved);
    })();
  </script>


  <!-- ë§ì¶¤ íŒ ì¡°íšŒ (GET /api/ai/tips?userId=&elecCount=&gasCount=) -->
    <!-- ë§ì¶¤ íŒ (ë¡œì»¬ ìƒì„± ë²„ì „, ë„¤íŠ¸ì›Œí¬ í˜¸ì¶œ ì—†ìŒ) -->
  <script>
    (function(){
      const $elec = document.getElementById('elecTips');
      const $gas  = document.getElementById('gasTips');
      if(!$elec || !$gas) return;

      function renderList(ul, items){
        ul.innerHTML = '';
        (items && items.length ? items : ['ë‚´ìš©ì´ ì—†ìŠµë‹ˆë‹¤.']).forEach(t=>{
          const li = document.createElement('li');
          li.textContent = String(t);
          ul.appendChild(li);
        });
      }

      function getEnv(){
        try{
          return JSON.parse(localStorage.getItem('envPrefs.v2') || '{}');
        }catch(e){
          return {};
        }
      }

      function buildTips(){
        const { housing, doors, windows } = getEnv();
        const elec = [];
        const gas  = [];

        // ê¸°ë³¸ ê³µí†µ íŒ
        elec.push('ì·¨ì¹¨ ì „ì— ë©€í‹°íƒ­ ìŠ¤ìœ„ì¹˜ë¥¼ í•œ ë²ˆì— OFF í•´ë³´ì„¸ìš”.');
        gas.push('ë³´ì¼ëŸ¬ ì˜¨ë„ë¥¼ 1~2â„ƒë§Œ ë‚®ì¶°ë„ ë‚œë°©ë¹„ë¥¼ ê½¤ ì¤„ì¼ ìˆ˜ ìˆì–´ìš”.');

        if(housing === 'ì›ë£¸'){
          elec.push('í•˜ë£¨ 1ì‹œê°„ë§Œ ì—ì–´ì»¨/ì „ê¸°ë‚œë¡œ ì‚¬ìš© ì‹œê°„ì„ ì¤„ì—¬ë„ ì „ê¸°ìš”ê¸ˆì´ ëˆˆì— ë„ê²Œ ì¤„ì–´ë“¤ì–´ìš”.');
          gas.push('ë‚œë°©ì€ ì§§ê²Œ ê°•í•˜ê²Œë³´ë‹¤, ì•½í•˜ê²Œ ì˜¤ë˜ ëŒë¦¬ëŠ” í¸ì´ ë” íš¨ìœ¨ì ì¼ ìˆ˜ ìˆì–´ìš”.');
        }
        if(housing === 'ì˜¤í”¼ìŠ¤í…”'){
          elec.push('ê³µìš©ì‹œì„¤ì´ ë§ì€ ë§Œí¼, ì‹¤ë‚´ ì¡°ëª…ê³¼ ì½˜ì„¼íŠ¸ ìœ„ì£¼ë¡œ ì ˆì•½ í¬ì¸íŠ¸ë¥¼ ì¡ì•„ë³´ì„¸ìš”.');
        }
        if(doors === 'ì—†ìŒ'){
          gas.push('í˜„ê´€ í‹ˆìƒˆ ë§‰ì´(ë¬¸í’ì§€)ë¥¼ ë¶™ì´ë©´ ë³µë„ ì°¬ ê³µê¸°ê°€ ëœ ë“¤ì–´ì™€ ë‚œë°©ë¹„ë¥¼ ì¤„ì¼ ìˆ˜ ìˆì–´ìš”.');
        }
        if(windows === 'ë‹¨ì°½'){
          elec.push('ì°½ë¬¸ í‹ˆìƒˆë¥¼ ë§‰ê±°ë‚˜ ë½ë½ì´ë¥¼ ë¶™ì´ë©´ ëƒ‰ë‚œë°© íš¨ìœ¨ì´ ì˜¬ë¼ê°€ìš”.');
        }
        if(windows === 'ë¡œì´/ë‹¨ì—´'){
          elec.push('ë‹¨ì—´ì°½ì´ë¼ë„ í–‡ë³•ì´ ì˜ ë“œëŠ” ë‚®ì—ëŠ” ì»¤íŠ¼ì„ ì—´ì–´ ìì—° ë‚œë°©ì„ ì´ìš©í•´ë³´ì„¸ìš”.');
        }

        return { elec, gas };
      }

      function updateTipsFromEnv(){
        const { elec, gas } = buildTips();
        renderList($elec, elec);
        renderList($gas, gas);
      }

      window.updateTipsFromEnv = updateTipsFromEnv;
      document.addEventListener('DOMContentLoaded', updateTipsFromEnv);
    })();
  </script>


  <!-- ë¼ì¸ì°¨íŠ¸ (GET /api/ai/daily-line?userId=&date=YYYY-MM-DD), 30ì´ˆ í´ë§ -->
    <!-- ë¼ì¸ì°¨íŠ¸ (ë¡œì»¬ ë”ë¯¸ ë°ì´í„° ë²„ì „, ë°±ì—”ë“œ X) -->
  <script>
    (function(){
      const container = document.querySelector('.chart-line');
      if(!container) return;

      function drawChart(labels, elec, gas){
        container.innerHTML = '';
        const svgNS = 'http://www.w3.org/2000/svg';
        const svg = document.createElementNS(svgNS,'svg');
        svg.classList.add('chart-svg');
        svg.setAttribute('viewBox','0 0 320 200');

        const maxVal = Math.max(
          ...elec.map(Number),
          ...gas.map(Number),
          1
        );
        const stepX = labels.length > 1 ? 280 / (labels.length - 1) : 0;
        const baseY = 170;

        function toPath(values){
          return values.map((v,i)=>{
            const x = 20 + stepX * i;
            const y = baseY - (Number(v)/maxVal)*120;
            return (i===0?'M':'L')+x+' '+y;
          }).join(' ');
        }

        // xì¶•
        const axis = document.createElementNS(svgNS,'line');
        axis.setAttribute('x1','20'); axis.setAttribute('y1',String(baseY));
        axis.setAttribute('x2','300'); axis.setAttribute('y2',String(baseY));
        axis.setAttribute('stroke','#e5e7eb'); axis.setAttribute('stroke-width','1');
        svg.appendChild(axis);

        // ì „ê¸° (íŒŒë€ ì‹¤ì„ )
        const pathElec = document.createElementNS(svgNS,'path');
        pathElec.setAttribute('d', toPath(elec));
        pathElec.setAttribute('fill','none');
        pathElec.setAttribute('stroke','#3b82f6');
        pathElec.setAttribute('stroke-width','2');
        svg.appendChild(pathElec);

        // ê°€ìŠ¤ (ì£¼í™© ì ì„ )
        const pathGas = document.createElementNS(svgNS,'path');
        pathGas.setAttribute('d', toPath(gas));
        pathGas.setAttribute('fill','none');
        pathGas.setAttribute('stroke','#f97316');
        pathGas.setAttribute('stroke-width','2');
        pathGas.setAttribute('stroke-dasharray','4 4');
        svg.appendChild(pathGas);

        container.appendChild(svg);
      }

      function getEnv(){
        try{
          return JSON.parse(localStorage.getItem('envPrefs.v2') || '{}');
        }catch(e){
          return {};
        }
      }

      function buildData(){
        const { housing } = getEnv();
        const labels = ['06ì‹œ','09ì‹œ','12ì‹œ','15ì‹œ','18ì‹œ','21ì‹œ','24ì‹œ'];
        let elec, gas;

        if(housing === 'ì›ë£¸'){
          elec = [0.2,0.4,0.8,0.6,1.0,0.9,0.5];
          gas  = [0.1,0.2,0.3,0.5,0.8,0.7,0.4];
        }else if(housing === 'ì˜¤í”¼ìŠ¤í…”'){
          elec = [0.3,0.6,0.9,0.7,1.1,1.0,0.6];
          gas  = [0.1,0.3,0.4,0.6,0.9,0.8,0.5];
        }else if(housing === 'ì•„íŒŒíŠ¸'){
          elec = [0.2,0.3,0.6,0.5,0.8,0.7,0.4];
          gas  = [0.1,0.2,0.3,0.4,0.6,0.5,0.3];
        }else{
          // ê¸°ë³¸ íŒ¨í„´
          elec = [0.2,0.3,0.7,0.6,0.9,0.8,0.4];
          gas  = [0.1,0.2,0.3,0.4,0.7,0.6,0.3];
        }

        // ë³´ê¸° ì¢‹ê²Œ 100 ë‹¨ìœ„ë¡œ ìŠ¤ì¼€ì¼ì—…
        elec = elec.map(v=>Math.round(v*100));
        gas  = gas.map(v=>Math.round(v*100));
        return { labels, elec, gas };
      }

      function updateChartFromEnv(){
        const { labels, elec, gas } = buildData();
        drawChart(labels, elec, gas);
      }

      window.updateChartFromEnv = updateChartFromEnv;
      document.addEventListener('DOMContentLoaded', updateChartFromEnv);
    })();
  </script>

  <!-- ë“œë¡œì–´ í† ê¸€ -->
  <script>
    (function(){
      const d=document, dr=d.getElementById('drawer'), sc=d.getElementById('scrim');
      if(!dr||!sc) return;
      const open=()=>{ dr.classList.add('open'); sc.classList.add('show'); };
      const close=()=>{ dr.classList.remove('open'); sc.classList.remove('show'); };
      d.getElementById('openDrawer')?.addEventListener('click', open);
      d.getElementById('openDrawer2')?.addEventListener('click', open);
      sc.addEventListener('click', close);
      d.addEventListener('keydown', e=>{ if(e.key==='Escape') close(); });
      d.addEventListener('DOMContentLoaded', close);
    })();
  </script>
</body>
</html>
