<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ì‹¤ì‹œê°„ ìš”ê¸ˆ</title>
  <link rel="stylesheet" href="style.css" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@latest/dist/web/variable/pretendardvariable-dynamic-subset.css" />
  <!-- í™˜ê²½ ì£¼ì… -->
  <script src="env.js"></script>
</head>
<body data-page="goals">
  <div class="wrap">
    <header>
      <div class="top-bar">
        <div class="time">--:--</div>
        <div class="status" aria-hidden="true"><span>ğŸ“¶</span><span>ğŸ“¡</span><span>ğŸ”‹</span></div>
      </div>
      <div class="top-actions">
        <a class="btn" href="log.html">ë¡œê·¸</a>
        <div>
          <a class="icon-btn" href="alerts.html" aria-label="ì•Œë¦¼">ğŸ””</a>
          <a class="icon-btn" href="search.html" aria-label="ê²€ìƒ‰">ğŸ”</a>
          <button class="icon-btn" id="openDrawer" aria-label="ì „ì²´ ë©”ë‰´">ğŸ§­</button>
        </div>
      </div>
    </header>

    <main class="section stack">
      <section class="panel">
        <h3>ì ˆì•½ ëª©í‘œ í•œëˆˆì— íŒŒì•…í•˜ê¸°</h3>

        <!-- ì ˆì•½ ëª©í‘œ ì¹´ë“œ -->
        <div class="goal-card">
          <div class="goal-head" style="display:flex;justify-content:space-between;align-items:flex-start;gap:10px;">
            <h3 class="goal-title" style="white-space:nowrap;margin:0;">ì´ë²ˆ ë‹¬ ì ˆì•½ ëª©í‘œ</h3>
            <div class="goal-side" style="display:flex;flex-direction:column;align-items:flex-end;line-height:1.2;">
              <span class="goal-meta" style="white-space:nowrap;">ëª©í‘œ: <span id="goalTarget">- ì›</span></span>
              <span class="goal-meta" style="white-space:nowrap;">ë‚¨ì€ ê¸ˆì•¡ <span id="goalRemain">- ì›</span></span>
            </div>
          </div>

          <div class="progress">
            <div class="progress-track"><div id="goalFill" class="progress-fill" style="width:0%"></div></div>
            <div class="progress-label">
              <span id="savedNow">ì´ë²ˆ ë‹¬ ì ˆê°ì•¡: - ì›</span>
              <span id="goalPct">0%</span>
            </div>
          </div>
          <form class="goal-form" id="goalForm">
            <input id="goalInput" class="input" type="number" min="0" step="1000" placeholder="ëª©í‘œ ê¸ˆì•¡ (ì˜ˆ: 50000)" />
            <div class="goal-actions">
              <button type="submit" class="btn">ì €ì¥</button>
              <button type="button" id="goalClear" class="btn">ì´ˆê¸°í™”</button>
            </div>
          </form>
        </div>

        <!-- ê·¼ì²˜ ìœ ì € ë¹„êµ -->
        <section class="neighbor-note">
          <p class="neighbor-title">
            ê·¼ì²˜ ìœ ì € ì¤‘ <strong class="hl">@@ë‹˜</strong>ì€ ì—ë„ˆì§€ ì ˆì•½ ì„±ê³µë¥ 
            <strong class="hl" id="rankTopText">ìƒìœ„ -%ì˜ˆìš”!</strong>
          </p>
          <div class="mini-colchart" aria-label="ê·¼ì²˜ ìœ ì € ë¹„êµ ê·¸ë˜í”„">
            <div class="col self"   id="colSelf"   style="--h:0%"><span class="val" id="selfVal">0%</span><span class="lab">ë‚˜</span></div>
            <div class="col others" id="colOthers" style="--h:0%"><span class="val" id="avgVal">0%</span><span class="lab" id="areaLab">ì§€ì—­ í‰ê· </span></div>
          </div>
        </section>

        <!-- ì¢…ëª©ë³„ ëª©í‘œ ì„¤ì •ê¸ˆì•¡ ë‹¬ì„±ë¥  -->
        <section class="cat-goals">
          <div class="goal-line" data-cat="elec" data-now="0" data-target="1">
            <div class="gl-head">
              <div class="label">âš¡ ì „ê¸°</div>
              <div class="val nowrap"><span class="now">0</span> / <span class="target">0</span> ì›</div>
            </div>
            <div class="gl-meter"><div class="gl-fill"></div></div>
            <div class="gl-pct nowrap">0%</div>
          </div>

          <div class="goal-line" data-cat="gas" data-now="0" data-target="1">
            <div class="gl-head">
              <div class="label">ğŸ”¥ ê°€ìŠ¤</div>
              <div class="val nowrap"><span class="now">0</span> / <span class="target">0</span> ì›</div>
            </div>
            <div class="gl-meter"><div class="gl-fill"></div></div>
            <div class="gl-pct nowrap">0%</div>
          </div>
        </section>
      </section>
    </main>

    <footer>
      <div class="tabs">
        <a class="tab" href="index.html">í™ˆ</a>
        <a class="tab" href="analysis.html">AI</a>
        <a class="tab active" href="goals.html">ìš”ê¸ˆ</a>
        <a class="tab" href="profile.html">ë§ˆì´</a>
        <button class="tab" id="openDrawer2" type="button">ì „ì²´</button>
      </div>
    </footer>
  </div>

  <div class="scrim" id="scrim"></div>
  <aside class="drawer" id="drawer" aria-label="ì „ì²´ ë©”ë‰´">
    <div class="d-hero">
      <div class="d-avatar">ğŸ‘¤</div>
      <div><div class="d-name">@@ë‹˜</div><div class="d-email">aaa123@gmail.com</div></div>
    </div>
    <div class="d-grid">
      <a class="d-btn" href="profile.html"><div class="emoji">ğŸ‘¤</div><div class="label">ì •ë³´ ê´€ë¦¬</div></a>
      <a class="d-btn" href="alerts.html"><div class="emoji">ğŸ””</div><div class="label">ì•Œë¦¼</div></a>
      <a class="d-btn" href="#"><div class="emoji">ğŸ“¢</div><div class="label">ê³µì§€ì‚¬í•­</div></a>
      <a class="d-btn" href="profile.html"><div class="emoji">ğŸ‘¤</div><div class="label">ë§ˆì´í˜ì´ì§€</div></a>
      <a class="d-btn" href="#"><div class="emoji">ğŸ’¬</div><div class="label">ê³ ê°ì„¼í„°</div></a>
      <a class="d-btn" href="search.html"><div class="emoji">ğŸ”</div><div class="label">ê²€ìƒ‰</div></a>
    </div>
    <div class="d-hr"></div>
    <div class="d-actions"><a href="#">ë¡œê·¸ì•„ì›ƒ</a><a href="#">íƒˆí‡´í•˜ê¸°</a></div>
  </aside>

  <!-- ìˆ«ì í¬ë§· & ì§„í–‰ë°” ê³„ì‚°(ë ˆì´ì•„ì›ƒ ë³€ê²½ ì—†ìŒ) -->
    <!-- ëª©í‘œ ë¼ì¸ ê³µí†µ UI í•¨ìˆ˜ (ê¸°ì¡´ ê·¸ëŒ€ë¡œ ì‚¬ìš©) -->
  <script>
    function fillGoalLine(row, now, target){
      const fmt = new Intl.NumberFormat('ko-KR');
      now = Number(now||0); target = Math.max(1, Number(target||0));
      const pct = Math.min(100, Math.round((now/target)*1000)/10);
      row.dataset.now = String(now); row.dataset.target = String(target);
      row.querySelector('.now').textContent = fmt.format(now);
      row.querySelector('.target').textContent = fmt.format(target);
      row.querySelector('.gl-pct').textContent = pct + '%';
      row.querySelector('.gl-fill').style.width = pct + '%';
    }
  </script>

  <!-- ì‹¤ì‹œê°„ ìš”ê¸ˆ: ë¡œì»¬ ë²„ì „ (API í˜¸ì¶œ X) -->
  <script>
    (function () {
      const fmt = new Intl.NumberFormat('ko-KR');
      const now = new Date();
      const ym = now.getFullYear() + '-' + String(now.getMonth() + 1).padStart(2, '0');
      const STORAGE_KEY = 'goalsPage.' + ym;

      function loadState() {
        try {
          return JSON.parse(localStorage.getItem(STORAGE_KEY) || '{}');
        } catch (e) {
          return {};
        }
      }

      function saveState(st) {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(st));
      }

      // ì…ë ¥í•œ "ì´ë²ˆ ë‹¬ ì ˆì•½ ëª©í‘œ ê¸ˆì•¡" ê¸°ì¤€ìœ¼ë¡œ ì „ì²´ ìƒíƒœ ê³„ì‚°
      function calcFromGoal(goalRaw) {
        const goal = Math.max(0, Number(goalRaw) || 0);

        // ëª©í‘œê°€ ìˆìœ¼ë©´ ê·¸ ì¤‘ 60% ì •ë„ëŠ” ì´ë¯¸ ì ˆê°í–ˆë‹¤ê³  ê°€ì •
        const saved = goal > 0 ? Math.round(goal * 0.6) : 0;
        const remain = Math.max(0, goal - saved);
        const savingPercent = goal > 0 ? Math.round((saved / goal) * 1000) / 10 : 0;

        // ì „ê¸°/ê°€ìŠ¤ ëª©í‘œë¥¼ 6:4 ë¹„ìœ¨ë¡œ ë‚˜ëˆ”
        const elecTarget = Math.round(goal * 0.6);
        const gasTarget  = Math.max(0, goal - elecTarget);

        // ì‹¤ì œ ì‚¬ìš©ëŸ‰ì€ ëª©í‘œì˜ ì¼ë¶€ë¼ê³  ê°€ì • (ì „ê¸° 70%, ê°€ìŠ¤ 50%)
        const elecNow = Math.round(elecTarget * 0.7);
        const gasNow  = Math.round(gasTarget  * 0.5);

        // ë­í‚¹/ë¹„êµìš© ë”ë¯¸ ë°ì´í„°
        const myRate = Math.max(0, Math.min(100, savingPercent));
        const areaAvgRate = myRate > 0
          ? Math.max(0, Math.min(100, myRate - 10))   // ë‚˜ë³´ë‹¤ ì¡°ê¸ˆ ë‚®ê²Œ
          : 40;                                       // ê¸°ë³¸ê°’ 40%
        const topPercent = Math.max(1, Math.min(99, Math.round(100 - myRate)));

        return {
          goalWon: goal,
          remainingWon: remain,
          savedWon: saved,
          savingPercent,
          cat: {
            elec: { used: elecNow, target: elecTarget },
            gas:  { used: gasNow,  target: gasTarget }
          },
          ranking: {
            myRate,
            areaAvgRate,
            topPercent,
            area: 'ë‚´ ì£¼ë³€'
          }
        };
      }

      function render(state) {
        const goal   = Math.max(0, Number(state.goalWon || 0));
        const remain = Math.max(0, Number(state.remainingWon || 0));
        const saved  = Math.max(0, Number(state.savedWon || 0));
        const percent = Math.max(0, Math.min(100, Number(state.savingPercent || 0)));
        const hasGoal = goal > 0;

        const goalTarget = document.getElementById('goalTarget');
        const goalRemain = document.getElementById('goalRemain');
        const savedNow   = document.getElementById('savedNow');
        const goalPct    = document.getElementById('goalPct');
        const goalFill   = document.getElementById('goalFill');
        const input      = document.getElementById('goalInput');

        if (goalTarget) goalTarget.textContent = fmt.format(goal) + ' ì›';
        if (goalRemain) goalRemain.textContent = fmt.format(remain) + ' ì›';
        if (savedNow)   savedNow.textContent   = 'ì´ë²ˆ ë‹¬ ì ˆê°ì•¡: ' + fmt.format(saved) + ' ì›';
        if (goalPct)    goalPct.textContent    = (Math.round(percent * 10) / 10).toString().replace(/\.0$/, '') + '%';
        if (goalFill)   goalFill.style.width   = percent + '%';
        if (input)      input.value            = goal ? String(goal) : '';

        // ë­í‚¹ / ê·¼ì²˜ ìœ ì € ë¹„êµ
        const r = state.ranking || {};
        const self = Math.max(0, Math.min(100, Number(r.myRate || 0)));
        const avg  = Math.max(0, Math.min(100, Number(r.areaAvgRate || 0)));
        const top  = Math.max(1, Math.min(99, Number(r.topPercent || 0)));

        const rankTopText = document.getElementById('rankTopText');
        const colSelf     = document.getElementById('colSelf');
        const selfVal     = document.getElementById('selfVal');
        const colOthers   = document.getElementById('colOthers');
        const avgVal      = document.getElementById('avgVal');
        const areaLab     = document.getElementById('areaLab');

        if (rankTopText) {
          if (hasGoal) {
            rankTopText.textContent = 'ìƒìœ„ ' + top + '%ì˜ˆìš”!';
          } else {
            rankTopText.textContent = 'ì ˆì•½ ëª©í‘œë¥¼ ì„¤ì •í•´ ë³´ì„¸ìš”!';
          }
        }
        if (colSelf)   colSelf.style.setProperty('--h', self + '%');
        if (selfVal)   selfVal.textContent = self.toFixed(0) + '%';
        if (colOthers) colOthers.style.setProperty('--h', avg + '%');
        if (avgVal)    avgVal.textContent = avg.toFixed(0) + '%';
        if (areaLab)   areaLab.textContent = (r.area || 'ë‚´ ì£¼ë³€') + ' ìœ ì €';

        // ì¢…ëª©ë³„ ëª©í‘œ ê·¸ë˜í”„ (ì „ê¸°/ê°€ìŠ¤)
        const byCat = state.cat || {};
        document.querySelectorAll('.goal-line').forEach((row) => {
          if (!hasGoal) {
            row.dataset.now = '0';
            row.dataset.target = '0';
            row.querySelector('.now').textContent = '0';
            row.querySelector('.target').textContent = '0';
            row.querySelector('.gl-pct').textContent = '0%';
            row.querySelector('.gl-fill').style.width = '0%';
            return;
          }
          const cat = row.dataset.cat;
          const d = byCat[cat];
          if (!d) {
            fillGoalLine(row, 0, 1);
            return;
          }
          fillGoalLine(row, Number(d.used || 0), Number(d.target || 1));
        });
      }

      function applyAndSaveFromGoalInput(rawGoal) {
        const computed = calcFromGoal(rawGoal);
        saveState(computed);
        render(computed);
      }

      document.addEventListener('DOMContentLoaded', () => {
        // ì´ˆê¸° ìƒíƒœ ë¡œë“œ
        let st = loadState();
        if (st.goalWon == null) {
          st = calcFromGoal(0);
          saveState(st);
        }
        render(st);

        // "ì €ì¥" ë²„íŠ¼
        document.getElementById('goalForm')?.addEventListener('submit', (e) => {
          e.preventDefault();
          const input = document.getElementById('goalInput');
          const val = Math.max(0, Number(input?.value || 0));
          applyAndSaveFromGoalInput(val);
        });

        // "ì´ˆê¸°í™”" ë²„íŠ¼
        document.getElementById('goalClear')?.addEventListener('click', () => {
          const st0 = calcFromGoal(0);
          saveState(st0);
          render(st0);
        });
      });
    })();
  </script>

  <!-- ì „ì²´ ë©”ë‰´ ë“œë¡œì–´ (ê¸°ì¡´ ê·¸ëŒ€ë¡œ) -->
  <script>
    (function(){
      const d=document, dr=d.getElementById('drawer'), sc=d.getElementById('scrim');
      const open=()=>{dr.classList.add('open'); sc.classList.add('show');};
      const close=()=>{dr.classList.remove('open'); sc.classList.remove('show');};
      d.getElementById('openDrawer')?.addEventListener('click', open);
      d.getElementById('openDrawer2')?.addEventListener('click', open);
      sc.addEventListener('click', close);
      d.addEventListener('keydown', e=>{ if(e.key==='Escape') close(); });
      d.addEventListener('DOMContentLoaded', close);
    })();
  </script>

</body>
</html>
