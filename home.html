<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ê´€ë¦¬ ìš”ê¸ˆ ì˜ˆì¸¡ Â· í™ˆ</title>
  <link rel="stylesheet" href="style.css" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@latest/dist/web/variable/pretendardvariable-dynamic-subset.css" />

  <!-- (ì˜µì…˜) ë¼ì¸/ë§‰ëŒ€ ì˜ì—­ ë ˆì´ì•„ì›ƒ ë³´ì • -->
  <style>
    body[data-page="home"] { touch-action: pan-y; }
    body[data-page="home"] .wrap { overflow-x: hidden; }

    /* â€œì˜ˆìƒ ê´€ë¦¬ ìš”ê¸ˆ í•œëˆˆì—â€ ì„¹ì…˜ë§Œ ê°€ë¡œ ìŠ¤í¬ë¡¤ */
    body[data-page="home"] section.panel[aria-label="ì˜ˆìƒ ê´€ë¦¬ ìš”ê¸ˆ í•œëˆˆì—"]{ overflow: hidden; }
    body[data-page="home"] section.panel[aria-label="ì˜ˆìƒ ê´€ë¦¬ ìš”ê¸ˆ í•œëˆˆì—"] .cards{
      display: flex !important;
      width: 100%;
      gap: 12px;
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
      touch-action: pan-x;
      overscroll-behavior-x: contain;
      scroll-snap-type: x mandatory;
      padding-bottom: 4px;
    }
    body[data-page="home"] section.panel[aria-label="ì˜ˆìƒ ê´€ë¦¬ ìš”ê¸ˆ í•œëˆˆì—"] .cards > .card{
      flex: 0 0 100%;
      max-width: 100%;
      scroll-snap-align: start;
    }

    /* ë§‰ëŒ€ ì°¨íŠ¸ë¥¼ ê·¸ë¦´ ì»¨í…Œì´ë„ˆ */
    .chart-line { position: relative; min-height: 200px; }
  </style>
</head>
<body data-page="home">
  <div class="wrap">

    <!-- Header -->
    <header>
      <div class="top-bar">
        <div class="time">19:30</div>
        <div class="status" aria-hidden="true"><span>ğŸ“¶</span><span>ğŸ“¡</span><span>ğŸ”‹</span></div>
      </div>
      <div class="top-actions">
        <a class="btn" href="log.html" aria-label="ë¡œê·¸">ë¡œê·¸</a>
        <div>
          <a class="icon-btn" href="alerts.html" aria-label="ì•Œë¦¼">ğŸ””</a>
          <a class="icon-btn" href="search.html" aria-label="ê²€ìƒ‰">ğŸ”</a>
          <button class="icon-btn" id="openDrawer" aria-label="ì „ì²´ ë©”ë‰´">ğŸ§­</button>
        </div>
      </div>
    </header>

    <!-- Main -->
    <main class="section stack">
      <!-- í”„ë¡œí•„ -->
        <div class="hero" aria-label="í”„ë¡œí•„">
    <span class="hero-badge">BETA</span>
    <div class="avatar" aria-hidden="true">ğŸ‘¤</div>
    <div>
        <div class="name">@@ë‹˜</div>
        <div class="email">aaa123@gmail.com</div>
    </div>
    </div>


      <!-- ì›” ìš”ì•½ -->
      <section class="summary" aria-label="ì´ë‹¬ ê´€ë¦¬ ìš”ê¸ˆ ìš”ì•½">
        <h2>@@ë‹˜ì˜ <span id="summaryMonth">ì´ë²ˆ ë‹¬</span> ì˜ˆìƒ ê´€ë¦¬ ìš”ê¸ˆ <span class="kpi" id="totalPrice">0 ì›</span></h2>
        <p class="small" id="deltaText">ë¹„êµ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘â€¦</p>
        <div class="bars">
          <div class="bar">
            <span class="label">ì§€ë‚œë‹¬</span>
            <div class="track"><div class="fill july" id="barJuly" style="width:50%"></div></div>
          </div>
          <div class="bar">
            <span class="label">ì´ë²ˆë‹¬</span>
            <div class="track"><div class="fill aug" id="barAug" style="width:50%"></div></div>
          </div>
        </div>
      </section>

      <!-- ì¹´ë“œ: ì „ê¸°/ê°€ìŠ¤ -->
      <section class="panel" aria-label="ì˜ˆìƒ ê´€ë¦¬ ìš”ê¸ˆ í•œëˆˆì—">
        <h3 style="margin:0 0 12px">ì˜ˆìƒ ê´€ë¦¬ ìš”ê¸ˆ í•œëˆˆì— ëª¨ì•„ë³´ê¸° &gt;</h3>
        <div class="cards">
          <article class="card" aria-label="ì „ê¸°">
            <div class="label">âš¡ ì˜ˆìƒ ì „ê¸° ìš”ê¸ˆ</div>
            <div class="kpi" id="elecPrice">0 ì›</div>
            <div class="donut" id="donutElec" style="--percent:0"><div class="center">ì „ê¸° ë¹„ì¤‘</div></div>
          </article>
          <article class="card" aria-label="ê°€ìŠ¤">
            <div class="label">ğŸ”¥ ì˜ˆìƒ ê°€ìŠ¤ ìš”ê¸ˆ</div>
            <div class="kpi" id="gasPrice">0 ì›</div>
            <div class="donut" id="donutGas" style="--percent:0"><div class="center">ê°€ìŠ¤ ë¹„ì¤‘</div></div>
          </article>
        </div>
      </section>

      <!-- ëˆ„ì  ë§‰ëŒ€ì°¨íŠ¸ -->
      <section class="panel">
        <h3>ì´ë²ˆ ë‹¬ ì „ê¸°/ê°€ìŠ¤ ëˆ„ì </h3>
        <div id="chartBars" class="chart-line"></div>
      </section>

      <!-- ì ˆì•½ ëª©í‘œ -->
      <section class="goal-card" aria-label="ì ˆì•½ ëª©í‘œ">
        <div class="goal-head">
          <h3 class="goal-title">ì´ë²ˆ ë‹¬ ì ˆì•½ ëª©í‘œ</h3>
          <span id="goalHint" class="goal-meta">ëª©í‘œë¥¼ ì„¤ì •í•´ ì§„í–‰ë¥ ì„ í™•ì¸í•´ ë³´ì„¸ìš”</span>
        </div>

        <div class="progress">
          <div class="progress-track"><div id="goalFill" class="progress-fill"></div></div>
          <div class="progress-label">
            <span id="savedNow">ì´ë²ˆ ë‹¬ ì ˆê°ì•¡: 0 ì›</span>
            <span id="goalPct">0%</span>
          </div>
        </div>

        <form class="goal-form" id="goalForm">
          <input id="goalInput" class="input" type="number" min="0" step="1000" placeholder="ëª©í‘œ ê¸ˆì•¡ì„ ì…ë ¥í•˜ì„¸ìš” (ì˜ˆ: 30000)" />
          <button type="submit" class="btn">ì €ì¥</button>
          <button type="button" id="goalClear" class="btn">ì´ˆê¸°í™”</button>
        </form>

        <div id="goalSuccess" style="display:none">
          <span class="badge-success">ëª©í‘œ ë‹¬ì„±!</span>
        </div>
      </section>
    </main>

    <!-- Footer Tabs -->
    <footer>
      <div class="tabs" aria-label="íƒ­">
        <a class="tab active" href="home.html" aria-label="í™ˆ">í™ˆ</a>
        <a class="tab" href="analysis.html" aria-label="AI ë¶„ì„">AI</a>
        <a class="tab" href="goals.html" aria-label="ì‹¤ì‹œê°„ ìš”ê¸ˆ">ìš”ê¸ˆ</a>
        <a class="tab" href="profile.html" aria-label="ë§ˆì´í˜ì´ì§€">ë§ˆì´</a>
        <button class="tab" id="openDrawer2" type="button" aria-label="ì „ì²´">ì „ì²´</button>
      </div>
    </footer>
  </div>

  <!-- Drawer (ê³µí†µ) -->
  <div class="scrim" id="scrim"></div>
  <aside class="drawer" id="drawer" aria-label="ì „ì²´ ë©”ë‰´">
    <div class="d-hero">
      <div class="d-avatar">ğŸ‘¤</div>
      <div>
        <div class="d-name">@@ë‹˜</div>
        <div class="d-email">aaa123@gmail.com</div>
      </div>
    </div>

    <div class="d-grid">
      <a class="d-btn" href="profile.html"><div class="emoji">ğŸ‘¤</div><div class="label">ì •ë³´ ê´€ë¦¬</div></a>
      <a class="d-btn" href="alerts.html"><div class="emoji">ğŸ””</div><div class="label">ì•Œë¦¼</div></a>
      <a class="d-btn" href="#"><div class="emoji">ğŸ“¢</div><div class="label">ê³µì§€ì‚¬í•­</div></a>
      <a class="d-btn" href="profile.html"><div class="emoji">ğŸ‘¤</div><div class="label">ë§ˆì´í˜ì´ì§€</div></a>
      <a class="d-btn" href="#"><div class="emoji">ğŸ’¬</div><div class="label">ê³ ê°ì„¼í„°</div></a>
      <a class="d-btn" href="search.html"><div class="emoji">ğŸ”</div><div class="label">ê²€ìƒ‰</div></a>
    </div>

    <div class="d-hr"></div>
    <div class="d-actions">
      <a href="#">ë¡œê·¸ì•„ì›ƒ</a>
      <a href="#">íƒˆí‡´í•˜ê¸°</a>
    </div>
  </aside>

  <!-- Scripts -->
  <script src="app3.js" defer></script>

  <!-- Drawer ì—´ê³ /ë‹«ê¸° -->
  <script>
    (function(){
      const d=document, dr=d.getElementById('drawer'), sc=d.getElementById('scrim');
      if(!dr || !sc) return;
      const open=()=>{ dr.classList.add('open'); sc.classList.add('show'); };
      const close=()=>{ dr.classList.remove('open'); sc.classList.remove('show'); };
      d.getElementById('openDrawer')?.addEventListener('click', open);
      d.getElementById('openDrawer2')?.addEventListener('click', open);
      sc.addEventListener('click', close);
      d.addEventListener('keydown', e=>{ if(e.key==='Escape') close(); });
      d.addEventListener('DOMContentLoaded', close);
    })();
  </script>

  <!-- âœ… ê³µí†µ í™˜ê²½ê°’ (ì£¼ì†Œ/ì‚¬ìš©ì) -->
  <script>
    // ê¸°ë³¸ê°’(ê°œë°œìš©). ìš´ì˜ì—ì„œëŠ” env.jsë¡œ window.APP_CONFë¥¼ ë¨¼ì € ì •ì˜í•˜ê±°ë‚˜, ì•„ë˜ë¥¼ ë¹ˆ ë¬¸ìì—´("")ë¡œ ë°”ê¾¸ì„¸ìš”.
    window.APP_CONF = window.APP_CONF || {};
    if (!('API_ORIGIN' in window.APP_CONF)) window.APP_CONF.API_ORIGIN = "http://localhost:8080"; // ë°°í¬ í”„ë¡ì‹œë©´ ""
    if (!('USER_ID' in window.APP_CONF))    window.APP_CONF.USER_ID    = 1;
  </script>

  <!-- âœ… 1) ë„ë„› ì°¨íŠ¸ ì—°ë™: GET /api/dashboard/donut?userId=&period=YYYY-MM -->
  <script>
  (function () {
    const fmt = new Intl.NumberFormat("ko-KR");

    function getEnv() {
      try {
        return JSON.parse(localStorage.getItem("envPrefs.v2") || "{}");
      } catch (e) {
        return {};
      }
    }

    function buildMockMonthly() {
      const env = getEnv();
      let elec = 23000;
      let gas  = 17000;

      // ì£¼ê±° í˜•íƒœì— ë”°ë¼ ì•½ê°„ ì¡°ì •
      switch (env.housing) {
        case "ì›ë£¸":
          elec -= 3000; gas -= 2000; break;
        case "ì˜¤í”¼ìŠ¤í…”":
          elec += 2000; gas += 1000; break;
        case "ì•„íŒŒíŠ¸":
          elec += 3000; gas += 3000; break;
      }
      // ì°½í˜¸ì— ë”°ë¼ ì•½ê°„ ì¡°ì •
      if (env.windows === "ë‹¨ì°½") {
        elec += 2000; gas += 1000;
      } else if (env.windows === "ë¡œì´/ë‹¨ì—´") {
        elec -= 1000; gas -= 500;
      }

      elec = Math.max(5000, elec);
      gas  = Math.max(3000, gas);
      const total = elec + gas;
      const elecRatio = elec / total;
      const gasRatio  = gas  / total;

      const now = new Date();
      const monthLabel = `${now.getMonth() + 1}ì›”`;
      const periodYm   = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, "0")}`;

      const mock = { periodYm, elec, gas, total, elecRatio, gasRatio, monthLabel };

      window.HOME_MOCK = window.HOME_MOCK || {};
      window.HOME_MOCK.monthly = mock;

      return mock;
    }

    function render() {
      const $elecPrice = document.getElementById("elecPrice");
      const $gasPrice  = document.getElementById("gasPrice");
      const $total     = document.getElementById("totalPrice");
      const $donutElec = document.getElementById("donutElec");
      const $donutGas  = document.getElementById("donutGas");
      const $month     = document.getElementById("summaryMonth");
      if (!$elecPrice || !$gasPrice || !$total || !$donutElec || !$donutGas || !$month) return;

      const data = buildMockMonthly();

      $month.textContent       = data.monthLabel;
      $elecPrice.textContent   = `${fmt.format(data.elec)} ì›`;
      $gasPrice.textContent    = `${fmt.format(data.gas)} ì›`;
      $total.textContent       = `${fmt.format(data.total)} ì›`;

      const elecPct = Math.max(0, Math.min(100, Math.round(data.elecRatio * 100)));
      const gasPct  = Math.max(0, Math.min(100, Math.round(data.gasRatio  * 100)));
      $donutElec.style.setProperty("--percent", elecPct);
      $donutGas.style.setProperty("--percent", gasPct);
    }

    document.addEventListener("DOMContentLoaded", render);
  })();
</script>


  <!-- âœ… 2) ëˆ„ì  ë§‰ëŒ€ ì°¨íŠ¸: GET /api/dashboard/bars?userId=&period=YYYY-MM -->
    <!-- ëˆ„ì  ë§‰ëŒ€ ì°¨íŠ¸ (í˜„ì‹¤ì ì¸ ë”ë¯¸ ë°ì´í„°, ë°±ì—”ë“œ í˜¸ì¶œ X) -->
  <script>
    (function () {
      const container = document.getElementById("chartBars") || document.querySelector(".chart-line");
      if (!container) return;

      // ìƒë‹¨ ì¹´ë“œì— ì°íŒ ì˜ˆìƒ ì „ê¸°/ê°€ìŠ¤ ìš”ê¸ˆì—ì„œ ìˆ«ìë§Œ ë½‘ì•„ì˜¤ê¸°
      function getMonthlyFromDOM() {
        const getNum = (id, fallback) => {
          const el = document.getElementById(id);
          if (!el) return fallback;
          const m = el.textContent.replace(/[^\d]/g, "");
          const n = Number(m || 0);
          return n > 0 ? n : fallback;
        };
        const elec = getNum("elecPrice", 23000);
        const gas  = getNum("gasPrice", 17000);
        return { elec, gas, total: elec + gas };
      }

      // â€œìƒì‹ì ì¸â€ íŒ¨í„´: ê±°ì˜ ì§ì„ ì— ê°€ê¹Œìš´ ì¦ê°€ + ì•½ê°„ì˜ êµ´ê³¡
      function buildBars() {
        const { elec, gas } = getMonthlyFromDOM();

        const today = new Date();
        // ì´ë²ˆ ë‹¬ ì‹¤ì œ ì¼ìˆ˜
        const daysInMonth = new Date(today.getFullYear(), today.getMonth() + 1, 0).getDate();

        const baseElec = elec / daysInMonth;
        const baseGas  = gas  / daysInMonth;

        const tmpElecCum = [];
        const tmpGasCum  = [];
        let eCum = 0;
        let gCum = 0;

        for (let day = 1; day <= daysInMonth; day++) {
          const t = day / daysInMonth;

          // í‰ì¼Â·ì£¼ë§Â·ì¤‘ë°˜ë¶€ì— ë”°ë¼ ì•½ê°„ì”©ë§Œ ì°¨ì´ë¥¼ ì¤Œ (0.9 ~ 1.1 ì •ë„)
          const elecFactor =
            0.95 + 0.1 * Math.sin(t * Math.PI)   // ì¤‘ê°„ì— ì‚´ì§ ë§ì•„ì§
            + (day % 7 === 0 ? 0.03 : 0);        // ì£¼ë§ì— ì•„ì£¼ ì•½ê°„ ë” ì‚¬ìš©

          const gasFactor =
            0.95 + 0.08 * Math.cos(t * Math.PI)  // ì´ˆë°˜Â·í›„ë°˜ ì•½ê°„ ì°¨ì´
            + (day % 7 === 0 ? 0.02 : 0);        // ì£¼ë§ì— ì•½ê°„ ì¦ê°€

          eCum += baseElec * elecFactor;
          gCum += baseGas  * gasFactor;

          tmpElecCum.push(eCum);
          tmpGasCum.push(gCum);
        }

        // ë§ˆì§€ë§‰ ë‚  ëˆ„ì ì´ ì •í™•íˆ ì›” ì˜ˆìƒ ìš”ê¸ˆê³¼ ë§ë„ë¡ ìŠ¤ì¼€ì¼ë§
        const eScale = elec / (tmpElecCum[tmpElecCum.length - 1] || 1);
        const gScale = gas  / (tmpGasCum[tmpGasCum.length - 1]  || 1);

        const bars = [];
        for (let i = 0; i < tmpElecCum.length; i++) {
          const e = Math.round(tmpElecCum[i] * eScale);
          const g = Math.round(tmpGasCum[i]  * gScale);
          bars.push({
            day: i + 1,
            elecCum: e,
            gasCum: g,
            totalCum: e + g,
          });
        }
        return { periodYm: "", bars };
      }

      function draw() {
        const data = buildBars();
        const bars = data.bars;
        if (!bars || !bars.length) {
          container.textContent = "ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.";
          return;
        }

        container.innerHTML = "";
        const width  = Math.max(240, container.clientWidth || 320);
        const height = 200;
        const M = { top: 10, right: 10, bottom: 24, left: 30 };
        const iw = width - M.left - M.right;
        const ih = height - M.top - M.bottom;

        const svg = document.createElementNS("http://www.w3.org/2000/svg", "svg");
        svg.setAttribute("width", width);
        svg.setAttribute("height", height);

        const maxY = bars.reduce((m, b) => Math.max(m, b.totalCum || 0), 1);
        const n = bars.length;
        const slot = iw / n;
        const barW = Math.max(3, Math.min(20, slot * 0.6));
        const baseY = height - M.bottom;

        // ë°°ê²½ ê·¸ë¦¬ë“œ
        const grid = document.createElementNS(svg.namespaceURI, "g");
        for (let i = 1; i <= 3; i++) {
          const y = M.top + (ih * i) / 4;
          const line = document.createElementNS(svg.namespaceURI, "line");
          line.setAttribute("x1", M.left);
          line.setAttribute("y1", y);
          line.setAttribute("x2", width - M.right);
          line.setAttribute("y2", y);
          line.setAttribute("stroke", "rgba(0,0,0,.08)");
          grid.appendChild(line);
        }
        svg.appendChild(grid);

        // ë§‰ëŒ€ë“¤ (ì•„ë˜ ê°€ìŠ¤, ìœ„ ì „ê¸°)
        const barsG = document.createElementNS(svg.namespaceURI, "g");
        bars.forEach((b, i) => {
          const xCenter = M.left + i * slot + slot / 2;
          const x = xCenter - barW / 2;

          const totalH = ih * (Math.max(0, b.totalCum || 0) / maxY);
          const elecH  = ih * (Math.max(0, b.elecCum || 0) / maxY);
          const gasH   = Math.max(0, totalH - elecH);

          const rGas = document.createElementNS(svg.namespaceURI, "rect");
          rGas.setAttribute("x", x);
          rGas.setAttribute("y", baseY - gasH);
          rGas.setAttribute("width", barW);
          rGas.setAttribute("height", gasH);
          rGas.setAttribute("fill", "#f97316");
          rGas.setAttribute("rx", "2");
          barsG.appendChild(rGas);

          const rElec = document.createElementNS(svg.namespaceURI, "rect");
          rElec.setAttribute("x", x);
          rElec.setAttribute("y", baseY - totalH);
          rElec.setAttribute("width", barW);
          rElec.setAttribute("height", elecH);
          rElec.setAttribute("fill", "#facc15");
          rElec.setAttribute("rx", "2");
          barsG.appendChild(rElec);

          // 1, 5, 10, ... , ë§ˆì§€ë§‰ ë‚ ë§Œ ë‚ ì§œ í‘œì‹œ
          if (b.day === 1 || b.day === bars.length || b.day % 5 === 0) {
            const t = document.createElementNS(svg.namespaceURI, "text");
            t.setAttribute("x", xCenter);
            t.setAttribute("y", baseY + 14);
            t.setAttribute("text-anchor", "middle");
            t.setAttribute("font-size", "10");
            t.setAttribute("fill", "rgba(0,0,0,.55)");
            t.textContent = b.day;
            barsG.appendChild(t);
          }
        });
        svg.appendChild(barsG);

        // ë²”ë¡€
        const lg = document.createElementNS(svg.namespaceURI, "g");
        [["#facc15", "ì „ê¸° ëˆ„ì "], ["#f97316", "ê°€ìŠ¤ ëˆ„ì "]].forEach((it, idx) => {
          const x = width - M.right - 120 + idx * 60;
          const y = M.top + 10;
          const box = document.createElementNS(svg.namespaceURI, "rect");
          box.setAttribute("x", x);
          box.setAttribute("y", y - 8);
          box.setAttribute("width", 10);
          box.setAttribute("height", 10);
          box.setAttribute("fill", it[0]);
          box.setAttribute("rx", "2");
          const tx = document.createElementNS(svg.namespaceURI, "text");
          tx.setAttribute("x", x + 14);
          tx.setAttribute("y", y);
          tx.setAttribute("font-size", "10");
          tx.textContent = it[1];
          tx.setAttribute("fill", "rgba(0,0,0,.6)");
          lg.appendChild(box);
          lg.appendChild(tx);
        });
        svg.appendChild(lg);

        container.appendChild(svg);
      }

      document.addEventListener("DOMContentLoaded", draw);
      let t;
      window.addEventListener("resize", () => {
        clearTimeout(t);
        t = setTimeout(draw, 120);
      });
    })();
  </script>



  <!-- âœ… 3) ì ˆì•½ ëª©í‘œ ì €ì¥: POST /api/dashboard/goal  &  ì¡°íšŒ: GET /api/dashboard/goal -->
  <script>
  (function () {
    const d = document;
    const form    = d.getElementById("goalForm");
    const input   = d.getElementById("goalInput");
    const hintEl  = d.getElementById("goalHint");
    const pctEl   = d.getElementById("goalPct");
    const fillEl  = d.getElementById("goalFill");
    const savedEl = d.getElementById("savedNow");
    const badge   = d.getElementById("goalSuccess");

    // ìƒë‹¨ ìš”ì•½ ì˜ì—­
    const totalEl = d.getElementById("totalPrice");
    const deltaEl = d.getElementById("deltaText");
    const barJuly = d.getElementById("barJuly");
    const barAug  = d.getElementById("barAug");

    const fmt = new Intl.NumberFormat("ko-KR");
    const clamp = (n, min, max) => Math.min(max, Math.max(min, n));
    const ym = () => {
      const now = new Date();
      return now.getFullYear() + "-" + String(now.getMonth() + 1).padStart(2, "0");
    };
    const STORAGE_KEY = "homeGoal." + ym();

    function msg(t, err) {
      if (!hintEl) return;
      hintEl.textContent = t;
      hintEl.style.color = err ? "#e11d48" : "";
    }

    function getMonthlyTotals() {
      const m = (window.HOME_MOCK && window.HOME_MOCK.monthly) || {};
      if (m.total && m.elec != null && m.gas != null) return m;
      const elec = 23000;
      const gas  = 17000;
      const total = elec + gas;
      return { elec, gas, total };
    }

    function loadState() {
      try {
        return JSON.parse(localStorage.getItem(STORAGE_KEY) || "{}");
      } catch (e) {
        return {};
      }
    }
    function saveState(st) {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(st));
    }

    function computeState(goalInput) {
      const monthly  = getMonthlyTotals();
      const baseline = Math.round(monthly.total * 1.1); // ì§€ë‚œë‹¬ì´ 10% ë” ì¼ë‹¤ê³  ê°€ì •
      const current  = Math.round(monthly.total);
      const target   = Math.max(0, Math.round(Number(goalInput) || 0));
      const saved    = Math.max(0, baseline - current);
      const savingPercent = baseline > 0 ? (saved / baseline * 100) : 0;
      const goalPercent   = target > 0 ? clamp(saved / target * 100, 0, 120) : 0;

      return { target, baseline, current, saved, savingPercent, goalPercent };
    }

    function renderFromState(st) {
      const monthly  = getMonthlyTotals();
      const baseline = Number(st.baseline || Math.round(monthly.total * 1.1));
      const current  = Number(st.current  || Math.round(monthly.total));
      const target   = Math.max(0, Number(st.target || 0));
      const saved    = Math.max(0, Number(st.saved  || Math.max(0, baseline - current)));
      const goalPercent = clamp(
        Number(st.goalPercent || (target > 0 ? (saved / target * 100) : 0)),
        0,
        120
      );

      if (input)  input.value = target ? String(target) : "";
      if (savedEl) savedEl.textContent = `ì´ë²ˆ ë‹¬ ì ˆê°ì•¡: ${fmt.format(saved)} ì›`;
      if (pctEl)   pctEl.textContent   = `${goalPercent.toFixed(1).replace(/\.0$/, "")}%`;
      if (fillEl)  fillEl.style.width  = `${clamp(goalPercent, 0, 100)}%`;
      if (badge)   badge.style.display = goalPercent >= 100 ? "block" : "none";

      if (target > 0) {
        msg(`ëª©í‘œ: ${fmt.format(target)} ì› Â· ë‚¨ì€ ê¸ˆì•¡ ${fmt.format(Math.max(0, target - saved))} ì›`, false);
      } else {
        msg("ëª©í‘œë¥¼ ì„¤ì •í•´ ì§„í–‰ë¥ ì„ í™•ì¸í•´ ë³´ì„¸ìš”", false);
      }

      if (totalEl) totalEl.textContent = `${fmt.format(current)} ì›`;
      if (baseline > 0 && deltaEl) {
        const diffPct = ((current - baseline) / baseline) * 100;
        const absPct  = Math.abs(diffPct).toFixed(1);
        deltaEl.textContent = diffPct <= 0
          ? `ì§€ë‚œë‹¬ ë³´ë‹¤ ${absPct}% ë‚®ì€ ê¸ˆì•¡ì´ì—ìš”!`
          : `ì§€ë‚œë‹¬ ë³´ë‹¤ ${absPct}% ë†’ì€ ê¸ˆì•¡ì´ì—ìš”!`;
      } else if (deltaEl) {
        deltaEl.textContent = "ë¹„êµí•  ì§€ë‚œë‹¬ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.";
      }

      if (barJuly && barAug) {
        const max = Math.max(baseline, current, 1);
        barJuly.style.width = `${Math.round(baseline / max * 100)}%`;
        barAug.style.width  = `${Math.round(current  / max * 100)}%`;
      }
    }

    function applyFromGoalInput(rawVal) {
      const st = computeState(rawVal);
      saveState(st);
      renderFromState(st);
    }

    document.addEventListener("DOMContentLoaded", () => {
      if (!form) return;

      const savedState = loadState();
      if (savedState && (savedState.target != null)) {
        renderFromState(savedState);
      } else {
        const st = computeState(0);
        saveState(st);
        renderFromState(st);
      }

      form.addEventListener("submit", (e) => {
        e.preventDefault();
        const val = Number(input?.value || 0);
        if (!Number.isFinite(val) || val < 0) {
          msg("ëª©í‘œ ê¸ˆì•¡ì„ 0 ì´ìƒ ìˆ«ìë¡œ ì…ë ¥í•´ ì£¼ì„¸ìš”.", true);
          return;
        }
        applyFromGoalInput(val);
      });

      d.getElementById("goalClear")?.addEventListener("click", () => {
        const st = computeState(0);
        st.target = 0;
        st.goalPercent = 0;
        saveState(st);
        if (input) input.value = "";
        if (badge) badge.style.display = "none";
        renderFromState(st);
      });
    });
  })();
</script>


</body>
</html>
